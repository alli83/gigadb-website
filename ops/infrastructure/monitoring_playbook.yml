---
# Deploy monitoring on an ec2 instance

- name: Install node exporter
  hosts: monitoring_hosts
  roles:
    - prometheus.prometheus.node_exporter

- name: Install Prometheus
  hosts: monitoring_hosts
  roles:
    - prometheus.prometheus.prometheus
  vars:
    prometheus_targets:
      node:
        - targets:
            - localhost:9100
          labels:
            env: gigascience-monitoring
    prometheus_scrape_configs:
      - job_name: "prometheus"
        metrics_path: "/metrics"
        static_configs:
          - targets:
              - "localhost:9090"
              - "localhost:9100"
      - job_name: "node"
        file_sd_configs:
          - files:
              - "{{ prometheus_config_dir }}/file_sd/node.yml"
      - job_name: "ec2-node"
        ec2_sd_configs:
          - region: ap-east-1
            access_key: "{{ prometheus_aws_access_key }}"
            secret_key: "{{ prometheus_aws_private_key }}"
            port: 9100
          - region: eu-west-3
            access_key: "{{ prometheus_aws_access_key }}"
            secret_key: "{{ prometheus_aws_private_key }}"
            port: 9100
        relabel_configs:
          - source_labels: [__meta_ec2_public_ip]
            replacement: '${1}:9100'
            target_label: __address__
          - source_labels: [__meta_ec2_tag_Name]
            target_label: instance
          - source_labels: [__meta_ec2_tag_Environment]
            target_label: environment
          - source_labels: [ instance ]
            regex: 'monitoring.*'
            action: drop


- name: Install Grafana
  hosts: monitoring_hosts
  roles:
    - ansible-grafana

- name: Configure Grafana
  hosts: monitoring_hosts
  collections:
    - community.grafana

  module_defaults:
    group/community.grafana.grafana:
      grafana_url: "http://localhost:3000"
      grafana_user: "admin"
      grafana_password: "admin"

  tasks:
    - name: Ensure Prometheus datasource exists.
      grafana_datasource:
        grafana_url: "http://localhost:3000"
        grafana_user: "admin"
        grafana_password: "admin"
        name: "datasource-prometheus"
        ds_type: "prometheus"
        ds_url: "http://localhost:9090"
        access: "proxy"
        validate_certs: "false"
        tls_skip_verify: "true"
        uid: gigascience-prometheus-datasource
        state: present
      register: datasource

    - debug:
        msg: "datasource output: {{ datasource }}"

    - name: Import Prometheus Grafana dashboard
      grafana_dashboard:
        dashboard_url: https://s3.ap-northeast-1.wasabisys.com/gigadb-monitoring-resources/node-exporter-full_rev31.json
        overwrite: true
